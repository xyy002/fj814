
#include "includes.h"


void exact_event_process(void)
{
	/**********0.1ms*************/
	TimeUs++;

	/**********2ms*************/
	if(TimeUs<20)return;
		TimeUs=0;Time2Ms++;
	t2msFlag=1; 

	/**************************/	
	if(Time2Ms<5)return;    
		Time2Ms=0;Time10Ms++;
	/**********10ms*************/
	t10msFlag=1;

	/***************************/
	if(Time10Ms<10)return;    
		Time10Ms=0;Time100Ms++;
	/**********100ms************/
	//t100msFlag=1;

	/***************************/
	if(Time100Ms<10)return;       
	Time100Ms=0;TimeSec++;
	/**********1sec*************/
	//t1SecFlag=1;
	
	/***************************/
	if(TimeSec<60)return;       
	TimeSec=0;
	/**********1min*************/
	if((bSysRunFlg)&&(bTestModeFlg==off))
	{
		if(TimeMin)TimeMin--;
	}	
}
   
void WDT_INITIAL (void) 
{
	CLRWDT();              //�忴�Ź�
    MISC0  = 0B00000000;   //���Ź�ʱ��32k
	WDTCON = 0B00001011;   //WDTPS=1010=1:1024,Ԥ��Ƶ1:1
                        	//��ʱʱ��=(1024*1)/32000=32ms             
}

void interrupt ISR(void)            	//PIC_HI-TECHʹ��
{ 
  	//��ʱ��2���жϴ���**********************
	if(T2UIE && T2UIF)                	
	{
		T2UIF = 1;                    	//д1�����־λ 
		ReadRf433();              	//��ȡ433M����
		exact_event_process();		
	} 

  	//��ʱ��4���жϴ���********************** 4KHZ/250US
	if(T4UIE && T4UIF)   //185US             	
	{
		T4UIF = 1;                    	//д1�����־λ  

		DisplayHandler();
		//RGBbreathing();
		if(BuzzerCnt)  //BEEP TIME
		{
			BELL=~BELL;
			BuzzerCnt--;	
			if(BuzzerCnt==0)
			{
				BELL=off;
			}
		}
	} 
    if(URTE && TXEF)            //���Ϳ����ж� && ���ͼĴ���Ϊ��
    {	
		send_uart_data();
	}	
	if(EPIF0&0x10)
	{
		EPIF0|=0x10;
	}
}  

void Sys_init()
{

	 OSCCON = 0B01100001;   //WDT 32KHZ IRCF=111=16MHZ/2=8MHZ,0.125US/T
	// OSCCON = 0B01110001;   //WDT 32KHZ IRCF=111=16MHZ/2=8MHZ,62.5NS/T
	 //Bit0=1,ϵͳʱ��Ϊ�ڲ�����
	 //Bit0=0,ʱ��Դ��FOSC<2��0>����������ѡ��ʱѡ��	
	 //OSCCON = 0B01110001;	 //16MHZ 1:1
	 //BIT7~BIT4:��ʱ�ӣ�ϵͳʱ�ӣ���Ƶ��ѡ��0111(1:1),0110(1:2),0101(1:4),0100(1:8),0011(1:16),0010,(1:32),0001(1:64),1xxx(1:128),0000(32kHz LIRC)
	 //BIT3:��������ʱ״̬λ��1������������FOSC<2:0>ָ�����ⲿʱ��֮�£�0�������������ڲ�����֮��
	 //BIT2:�����ڲ�ʱ��״̬�� 1��HIRC is ready��0��HIRC is not ready
	 //Bit1�������ڲ�ʱ��״̬��1��LIRC is ready��0��LIRC is not ready
	 //Bit0:ϵͳʱ��ѡ��λ��1��ϵͳʱ��ѡ��Ϊ�ڲ�������0��ʱ��Դ��FOSC<2:0>����
	 
	 INTCON = 0B00000000; //
	 
	 PORTA = 0B00000000;	 
	 TRISA = 0B00000000;	 //PA������� 0-��� 1-����
	 PORTB = 0B00000000;	 
	 TRISB = 0B00010000;	 //PB������� 0-��� 1-���� 						 
	 PORTC = 0B00000000;	 
	 TRISC = 0B00000000;	 //PC������� 0-��� 1-���� 	 
	 PORTD = 0B00000000;	 
	 TRISD = 0B00000000;	 //PD������� 0-��� 1-����
	 
	 WPUA = 0B00000000; 	 //PA�˿��������� 1-������ 0-������
	 WPUB = 0B00010000; 	 //PB�˿��������� 1-������ 0-������
	 WPUC = 0B00000000; 	 //PC�˿��������� 1-������ 0-������
	 WPUD = 0B00000000; 	 //PD�˿��������� 1-������ 0-������
	 
	 WPDA = 0B00000000; 	 //PA�˿��������� 1-������ 0-������
	 WPDB = 0B00000000; 	 //PB�˿��������� 1-������ 0-������
	 WPDC = 0B00000000; 	 //PC�˿��������� 1-������ 0-������
	 WPDD = 0B00000000; 	 //PD�˿��������� 1-������ 0-������
	 
	 PSRC0	= 0B11111111;	 //PORTA,PORTBԴ�����������
	 //BIT7~BIT6:PORTB[7:4]Դ������������,BIT5~BIT4:PORTB[3:0]Դ������������ 
	 //BIT3~BIT2:PORTA[7:4]Դ������������,BIT1~BIT0:PORTA[3:0]Դ������������
	 
	 PSRC1	= 0B11111111;	 //PORTC,PORTDԴ�����������    
	 //BIT7~BIT6:PORTD[7:4]Դ������������,BIT5~BIT4:PORTD[3:0]Դ������������ 
	 //BIT3~BIT2:PORTC[7:4]Դ������������,BIT1~BIT0:PORTC[3:0]Դ������������
	 
	 PSINK0 = 0B11111111;	 //PORTA������������ 0:��С��1:���
	 PSINK1 = 0B11111111;	 //PORTB������������ 0:��С��1:���
	 PSINK2 = 0B11111111;	 //PORTC������������ 0:��С��1:���
	 PSINK3 = 0B11111111;	 //PORTD������������ 0:��С��1:��� 
	 
	 ANSELA = 0B00000000;
	 
	//    AFP0 |= 0B01010000; 
	//    AFP1 |= 0B00000010; 
	//    AFP2 |= 0B00000000; //
}

/*-------------------------------------------------
 *	�������ƣ�Time1Initial
 *	���ܣ�     TIM1 CH1�����������Ϊ32kHz�ķ��� ����
 *	���������
 *	���ز������� 
 -------------------------------------------------*/
void Time1Initial(void)
{
	//PCKEN |=0B00000010;    //ʹ��timer1ʱ��ģ��
    CKOCON=0B00100000;
    TCKSRC=0B00000001;    //TIM1ʱ��ΪHIRC��1��Ƶ 16k
    //TCKSRC=0B00000011;    //TIM1ʱ��ΪHIRC��2��Ƶ
    //BIT7��Ƶ����ģʽ��1 = 256K ��Ƶ��ģʽ,0 = 32K ��Ƶ��ģʽ
    //BIT6~BIT4TIM2ʱ��Դѡ��λ
			//ֵ	ʱ��Դ
			//0	ϵͳʱ��/��ʱ��
			//1	HIRC
			//2	XTʱ��/�ⲿʱ��
			//3	HIRC��2��Ƶ
			//4	XTʱ��/�ⲿʱ�ӵ�2��Ƶ
			//5	LIRC
			//6	LPʱ��/�ⲿʱ��
			//7	LPʱ��/�ⲿʱ�ӵ�2λƵ
		//BIT3:����λ
		//BIT2~BIT1:TIM1ʱ��Դѡ��λ
			//ֵ	ʱ��Դ
			//0	ϵͳʱ��/��ʱ��
			//1	HIRC
			//2	XTʱ��/�ⲿʱ��
			//3	HIRC��2��Ƶ
			//4	XTʱ��/�ⲿʱ�ӵ�2��Ƶ
			//5	LIRC
			//6	LPʱ��/�ⲿʱ��
			//7	LPʱ��/�ⲿʱ�ӵ�2λƵ


    TIM1CR1 =0B10000101;  //Ԥ�����������ض������ϼ�������������ʹ��
    //BIT7:�Զ�Ԥװ������λ
			//0��TIM1_ARR�Ĵ���û�л��壬�����Ա�ֱ��д�룻
			//1��TIM1_ARR�Ĵ�����Ԥװ�ػ��������塣
		//BIT6~BIT5:ѡ�����ģʽ
			//00�����ض���ģʽ�����������ݷ���λ(DIR)���ϻ����¼�����
			//01���������ģʽ1����������������Ϻ����¼���������Ϊ�����ͨ��(TIM1_CCMRx�Ĵ�����CciS=00)������Ƚ��жϱ�־λ��ֻ�ڼ��������¼���ʱ����1�� 
			//10:�������ģʽ2����������������Ϻ����¼���������Ϊ�����ͨ��(TIM1_CCMRx�Ĵ�����CciS=00)������Ƚ��жϱ�־λ��ֻ�ڼ��������ϼ���ʱ����1��
			//11���������ģʽ3����������������Ϻ����¼���������Ϊ�����ͨ��(TIM1_CCMRx�Ĵ�����CciS=00)������Ƚ��жϱ�־λ���ڼ��������Ϻ����¼���ʱ������1��
		//BIT4:����
			//0�����������ϼ�����
			//1�����������¼�����
		//BIT3:������ģʽ
			//0���ڷ��������¼�ʱ����������ֹͣ��
			//1���ڷ�����һ�θ����¼�(���CENλ)ʱ��������ֹͣ��
		//BIT2:��������Դ
			//0�����UDIS�������������¼�����������һ�¼�����һ�������жϣ�
			//�Ĵ���������(����������/����)
			//��������UGλ
			//ʱ��/���������������ĸ���
			//1�����UDIS�������������¼�����ֻ�е������¼�����ʱ�Ų��������жϣ���UIF��1��
			//�Ĵ���������(����������/����)
		//BIT1:	��ֹ����
			//0��һ�������¼���������������(UEV)�¼���
			//���������/����
			//�������������¼�
			//ʱ��/����ģʽ������������Ӳ����λ������ļĴ�����װ�����ǵ�Ԥװ��ֵ��
			//1�������������¼���Ӱ�ӼĴ���(ARR��PSC��CCRx)�������ǵ�ֵ�����������UGλ��ʱ��/����������������һ��Ӳ����λ�����������Ԥ��Ƶ�������³�ʼ����
		//BIT0	���������� T1CEN
			//0����ֹ��������
			//1��ʹ�ܼ�������


    TIM1SMCR=0B00000000;
	    //BIT7����/��ģʽ
			//0�������ã�
			//1����������(TRGI)�ϵ��¼����ӳ��ˣ���������ʱ��1�����ĴӶ�ʱ���������ͬ��(ͨ��TRGO)��

		//BIT6~BIT4������ѡ��,��3λѡ������ѡ��ͬ���������Ĵ������롣
			//000���ڲ�����ITR0���ӵ�TIM6 TRGO (�����û��TIM6�����Թ̶���0)	
			//001������	
			//010���ڲ�����ITR2���ӵ�TIM5 TRGO(�����û��TIM5�����Թ̶���0)
			//011������	
			//100��TI1�ı��ؼ����(TI1F_ED)
			//101���˲���Ķ�ʱ������1(TI1FP1)
			//110���˲���Ķ�ʱ������2(TI2FP2)
			//111���ⲿ��������(ETRF)
			//ע����Щλֻ����δ�õ�(��SMS=000)ʱ���ı䣬�Ա����ڸı�ʱ��������ı��ؼ�⡣
		//BIT3:����
		//BIT2~BIT0��ʱ��/����/��ģʽѡ��,��ѡ�����ⲿ�źţ������ź�(TRGI)����Ч������ѡ�е��ⲿ���뼫�����(��������ƼĴ����Ϳ��ƼĴ�����˵��)
			//000��ʱ��/������������ֹ �C ���CEN=1����Ԥ��Ƶ��ֱ�����ڲ�ʱ��������
			//001��������ģʽ1 �C ����TI1FP1�ĵ�ƽ����������TI2FP2�ı�������/�¼�����
			//010��������ģʽ2 �C ����TI2FP2�ĵ�ƽ����������TI1FP1�ı�������/�¼�����
			//011��������ģʽ3 �C ������һ������ĵ�ƽ����������TI1FP1��TI2FP2�ı�������/�¼�����
			//100����λģʽ �C ��ѡ�еĴ�������(TRGI)��������ʱ���³�ʼ�������������Ҳ���һ�����¼Ĵ������źš�
			//101���ſ�ģʽ �C ����������(TRGI)Ϊ��ʱ����������ʱ�ӿ�����һ�����������Ϊ�ͣ��������ֹͣ(������λ)����������������ֹͣ�����ܿصġ�
			//110������ģʽ �C �������ڴ�������TRGI������������(������λ)��ֻ�м��������������ܿصġ�
			//111���ⲿʱ��ģʽ1 �C ѡ�еĴ�������(TRGI)��������������������
			//ע�����TI1F_ED��ѡΪ��������(TS=100)ʱ����Ҫʹ���ſ�ģʽ��������ΪTI1F_ED��ÿ��
			//TI1F�仯ʱֻ�����һ�����壬Ȼ���ſ�ģʽ��Ҫ��鴥������ĵ�ƽ��


    TIM1IER =0B00000000;//��ֹ�����ж�
    //BIT7������ɲ���ж�
			//0����ֹɲ���жϣ�
			//1������ɲ���жϡ�
		//BIT6�������ж�ʹ��
			//0����ֹ�����жϣ�
			//1��ʹ�ܴ����жϡ�
		//BIT5������COM�ж�
			//0����ֹCOM�жϣ�
			//1������COM�жϡ�
		//BIT4����������/�Ƚ�4�ж�
			//0����ֹ����/�Ƚ�4�жϣ�
			//1����������/�Ƚ�4�жϡ�
		//BIT3����������/�Ƚ�3�ж�
			//0����ֹ����/�Ƚ�3�жϣ�
			//1����������/�Ƚ�3�жϡ�
		//BIT2����������/�Ƚ�2�ж�
			//0����ֹ����/�Ƚ�2�жϣ�
			//1����������/�Ƚ�2�жϡ�
		//BIT1����������/�Ƚ�1�ж�
			//0����ֹ����/�Ƚ�1�жϣ�
			//1����������/�Ƚ�1�жϡ�
		//BIT0�����������ж�
			//0����ֹ�����жϣ�
			//1�����������жϡ�

    TIM1SR1 =0B00000000;
    //BIT7��ɲ���жϱ��,һ��ɲ��������Ч����Ӳ���Ը�λ��1�����ɲ��������Ч�����λ����������0��
			//0����ɲ���¼�������
			//1��ɲ�������ϼ�⵽��Ч��ƽ��
		//BIT6���������жϱ��,�����������¼�(����ģʽ���������ڳ��ſ�ģʽ�������ģʽʱ����TRGI����˼�⵽��Ч���أ����ſ�ģʽ�µ���һ����)ʱ��Ӳ���Ը�λ��1������������0��                                        
			//0���޴������¼�������
			//1�������жϵȴ���Ӧ��
		//BIT5��COM�жϱ��,һ������COM�¼�(������/�ȽϿ���λ��CciE��CciNE��OciM�ѱ�����)��λ��Ӳ����1������������0 ��                                                                                                                                                  
			//0����COM�¼�������
			//1��COM�жϵȴ���Ӧ��
		//BIT4������/�Ƚ�4�жϱ��
			//�ο�CC1IF������
		//BIT3������/�Ƚ�3�жϱ��
			//�ο�CC1IF������
		//BIT2������/�Ƚ�2�жϱ��
			//�ο�CC1IF������
		//BIT1������/�Ƚ�1�жϱ��  ���ͨ��CC1����Ϊ���ģʽ����������ֵ��Ƚ�ֵƥ��ʱ��λ��Ӳ����1���������ĶԳ�ģʽ�³���(�ο�TIM1_CR1�Ĵ�����CMSλ)������������0��
			//0����ƥ�䷢����
			//1��TIMx_CNT��ֵ��TIMx_CCR1��ֵƥ�䡣
			//ע�������ĶԳ�ģʽ�£���������ֵΪ0ʱ�����ϼ�������������ֵΪARRʱ�����¼���������0���ϼ�����ARR-1������ARR���¼�����1������ˣ������е�SMSλֵ��������ֵ�����ñ�ǡ����ǣ����CCR1>ARR����CNT�ﵽARRֵʱ��CC1IF��1��
			//���ͨ��CC1����Ϊ����ģʽ���������¼�����ʱ��λ��Ӳ����1������������0��ͨ����TIM1_CCR1L��0��
			//0�������벶�������
			//1��������ֵ�ѱ�����(����)��TIM1_CCR1(��IC1�ϼ�⵽����ѡ������ͬ�ı���)��
		//BIT0�������жϱ��,�����������¼�ʱ��λ��Ӳ����1������������0��
			//0���޸����¼�������
			//1�������¼��ȴ���Ӧ�����Ĵ���������ʱ��λ��Ӳ����1��
			//��TIM1_CR1�Ĵ�����UDIS=0�������������������ʱ��
			//��TIM1_CR1�Ĵ�����UDIS=0��URS=0��������TIM1_EGR�Ĵ�����UGλ�����Լ�����
			//CNT���³�ʼ��ʱ��
			//��TIM1_CR1�Ĵ�����UDIS=0��URS=0����������CNT�������¼����³�ʼ��ʱ (�ο�0
			//��ģʽ���ƼĴ���TIM1_SMCR)��

    TIM1SR2 =0B00000000;
    
    TIM1EGR =0B00000000;
    //BIT7������ɲ���¼�,��λ��������1�����ڲ���һ��ɲ���¼�����Ӳ���Զ���0��
			//0���޶�����
			//1������һ��ɲ���¼�����ʱMOE=0��BIF=1����������Ӧ���ж�(BIE=1)���������Ӧ���жϡ�
		//BIT6�����������¼�,��λ��������1�����ڲ���һ�������¼�����Ӳ���Զ���0��
			//0���޶�����
			//1��TIM1_SR�Ĵ�����TIF=1����������Ӧ���жϣ�TIE=1�����������Ӧ���жϡ�
		//BIT5������/�Ƚ��¼����������Ƹ��¸�λ��������1����Ӳ���Զ���0��    
			//0���޶�����
			//1����CCPC=1����������CCIE��CCINE��CciP��CciNP��OCIMλ��
			//ע����λֻ��ӵ�л��������ͨ����Ч��
		//BIT4����������/�Ƚ�4�¼�
			//�ο�CC1G������
		//BIT3����������/�Ƚ�3�¼�
			//�ο�CC1G������
		//BIT2����������/�Ƚ�2�¼�
			//�ο�CC1G������
		//BIT1����������/�Ƚ�1�¼�
			//��λ��������1�����ڲ���һ������/�Ƚ��¼�����Ӳ���Զ���0��
			//0���޶�����
			//1����ͨ��CC1�ϲ���һ������/�Ƚ��¼��� ��ͨ��CC1����Ϊ�����
			//����CC1IF=1����������Ӧ���жϣ��������Ӧ���жϡ���ͨ��CC1����Ϊ���룺
			//��ǰ�ļ�����ֵ��������TIM1_CCR1�Ĵ���������CC1IF=1����������Ӧ���жϣ��������Ӧ���жϡ���CC1IF�Ѿ�Ϊ1��������CC1OF=1��
		//BIT0�����������¼�
			//��λ��������1����Ӳ���Զ���0��
			//0���޶�����
			//1�����³�ʼ����������������һ�������¼���ע��Ԥ��Ƶ���ļ�����Ҳ����0(����Ԥ��Ƶϵ������)���������ĶԳ�ģʽ�»�DIR=0(���ϼ���)�����������0����DIR=1(���¼���)�������ȡTIM1_ARR��ֵ��

    
    TIM1CCMR1 =0B00000000;//CC1ͨ��������Ϊ���
		//BIT7������Ƚ�1����ʹ��
			//��λ����ʹ��ʹ��TIM1_TRIG�����ϵ��ⲿ�¼�����ͨ����������ź�(OC1REF)���ο�17.5.9���ⲿ�¼�����ʱ���OCREF�ź�
			//0��OC1REF ����ETRF���루����TIM1_TRIG���ţ���Ӱ�죻
			//1��һ����⵽ETRF����ߵ�ƽ��OC1REF=0��
		//BIG6~BIT4������Ƚ�1ģʽ,��3λ����������ο��ź�OC1REF�Ķ�������OC1REF������OC1��ֵ��OC1REF�Ǹߵ�ƽ��Ч����OC1����Ч��ƽȡ����CC1Pλ��
			//000�����ᡣ����ȽϼĴ���TIM1_CCR1�������TIM1_CNT��ıȽ϶�OC1REF�������ã�
			//001��ƥ��ʱ����ͨ��1�����Ϊ��Ч��ƽ����������TIM1_CNT��ֵ�벶��/�ȽϼĴ���1(TIM1_CCR1)��ͬʱ��ǿ��OC1REFΪ�ߡ�
			//010��ƥ��ʱ����ͨ��1�����Ϊ��Ч��ƽ����������TIM1_CNT��ֵ�벶��/�ȽϼĴ���1(TIM1_CCR1)��ͬʱ��ǿ��OC1REFΪ�͡�
			//011����ת����TIM1_CCR1=TIM1_CNTʱ����תOC1REF�ĵ�ƽ��
			//100��ǿ��Ϊ��Ч��ƽ��ǿ��OC1REFΪ�͡�
			//101��ǿ��Ϊ��Ч��ƽ��ǿ��OC1REFΪ�ߡ�
			//110��PWMģʽ1�� �����ϼ���ʱ��һ��TIM1_CNT<TIM1_CCR1ʱͨ��1Ϊ��Ч��ƽ������Ϊ��Ч��ƽ�������¼���ʱ��һ��TIM1_CNT>TIM1_CCR1ʱͨ��1Ϊ��Ч��ƽ(OC1REF=0)�� ����Ϊ��Ч��ƽ(OC1REF=1)��
			//111��PWMģʽ2�� �����ϼ���ʱ��һ��TIM1_CNT<TIM1_CCR1ʱͨ��1Ϊ��Ч��ƽ������Ϊ��Ч��ƽ�������¼���ʱ��һ��TIM1_CNT>TIM1_CCR1ʱͨ��1Ϊ��Ч��ƽ������Ϊ��Ч��ƽ��
			//ע1��һ��LOCK������Ϊ3(TIM1_BKR�Ĵ����е�LOCKλ)����CC1S=00(��ͨ�����ó����) ���λ���ܱ��޸ġ�
			//ע2����PWMģʽ1��PWMģʽ2�У�ֻ�е��ȽϽ���ı��˻�������Ƚ�ģʽ�дӶ���ģʽ�л���PWMģʽʱ��OC1REF��ƽ�Ÿı䡣(�ο�17.5.7PWMģʽ)
			//ע3�����л��������ͨ���ϣ���Щλ��Ԥװ�صġ����TIM1_CR2�Ĵ�����CCPC=1��OCM λֻ����COM�¼�����ʱ���Ŵ�Ԥװ��λȡ��ֵ��
		//BIT3������Ƚ�1Ԥװ��ʹ��
			//0����ֹTIM1_CCR1�Ĵ�����Ԥװ�ع��ܣ�����ʱд��TIM1_CCR1�Ĵ�����������д�����ֵ���������á�
			//1������TIM1_CCR1�Ĵ�����Ԥװ�ع��ܣ���д��������Ԥװ�ؼĴ���������TIM1_CCR1��Ԥװ��ֵ�ڸ����¼�����ʱ����������ǰ�Ĵ����С�
			//ע1��һ��LOCK������Ϊ3(TIM1_BKR�Ĵ����е�LOCKλ)����CC1S=00(��ͨ�����ó����) ���λ���ܱ��޸ġ�
			//ע2��Ϊ�˲�����ȷ����PWMģʽ�±���ʹ��Ԥװ�ع��ܡ����ڵ�����ģʽ��(TIM1_CR1�Ĵ�����OPM=1)�������Ǳ���ġ�
		//BIT2������Ƚ�1 ����ʹ��,��λ���ڼӿ�CC����Դ��������¼�����Ӧ��
			//0�����ݼ�������CCR1��ֵ��CC1������������ʹ�������Ǵ򿪵ġ�����������������һ����Ч��ʱ������CC1�������С��ʱΪ5��ʱ�����ڡ�
			//1�����뵽����������Ч�ص����þ�������һ�αȽ�ƥ�䡣��ˣ�OC������Ϊ�Ƚϵ�ƽ����ȽϽ���޹ء���������������Ч�غ�CC1��������ʱ������Ϊ3��ʱ�����ڡ�
			//OCFEֻ��ͨ�������ó�PWM1��PWM2ģʽʱ�����á�
		//BIT1~BIT0������/�Ƚ�1 ѡ����2λ����ͨ���ķ���(����/���)��������ŵ�ѡ��
			//00��CC1ͨ��������Ϊ�����
			//01��CC1ͨ��������Ϊ���룬IC1ӳ����TI1FP1�ϣ�
			//10��CC1ͨ��������Ϊ���룬IC1ӳ����TI2FP1�ϣ�
			//11��CC1ͨ��������Ϊ���룬IC1ӳ����TRC�ϡ���ģʽ���������ڲ����������뱻ѡ��ʱ(��
			//TIM1_SMCR�Ĵ�����TSλѡ��)��
			//ע��CC1S����ͨ���ر�ʱ(TIM1_CCER1�Ĵ�����CC1E=0)���ǿ�д�ġ�


    TIM1CCMR2 =0B00000000;
    TIM1CCMR3 =0B00000000;
	TIM1CCMR4 =0B00000000; //4
    //TIM1CCMR4 =0B01101000; //4
    
    TIM1CCER1 =0B00000000; //�Ƚ�1�������ʹ�ܣ��͵�ƽ��Ч���Ƚ���1���ʹ�ܣ��͵�ƽ��Ч
    //BIT7�����벶��/�Ƚ�2����������ԡ��ο�CC1NP��������
		//BIT6�����벶��/�Ƚ�2�������ʹ�ܡ��ο�CC1NE��������
		//BIT5�����벶��/�Ƚ�2������ԡ��ο�CC1P��������
		//BIT4�����벶��/�Ƚ�2���ʹ�ܡ��ο�CC1E��������
		//BIT3�����벶��/�Ƚ�1�����������
			//0��OC1N�ߵ�ƽ��Ч��
			//1��OC1N�͵�ƽ��Ч��
			//ע1��һ��LOCK����(TIM1_BKR�Ĵ����е�LCCKλ)��Ϊ3��2��CC1S=00(ͨ������Ϊ���) ���λ���ܱ��޸ġ�
			//ע2�������л��������ͨ������λ��Ԥװ�صġ����CCPC=1��TIM1_CR2�Ĵ�������ֻ����
			//COM�¼�����ʱ��CC1NPλ�Ŵ�Ԥװ��λ��ȡ��ֵ��
		//BIT2�����벶��/�Ƚ�1�������ʹ��
			//0���رգ� OC1N��ֹ��������OC1N�������ƽ������MOE��OSSI��OSSR��OIS1��
			//OIS1N��CC1Eλ��ֵ��
			//1�������� OC1N�ź��������Ӧ��������ţ��������ƽ������MOE��OSSI��OSSR��
			//OIS1��OIS1N��CC1Eλ��ֵ��
			//ע�������л��������ͨ������λ��Ԥװ�صġ����CCPC=1(TIM1_CR2�Ĵ���)��ֻ����
			//COM�¼�����ʱ��CC1NEλ�Ŵ�Ԥװ��λ��ȡ��ֵ��
		//BIT1�����벶��/�Ƚ�1�������CC1ͨ������Ϊ�����
			//0��OC1�ߵ�ƽ��Ч��
			//1��OC1�͵�ƽ��Ч��
			//CC1ͨ������Ϊ����(�ο�ͼ61)��
			//0������������TI1F�ĸߵ�ƽ�������أ�
			//1������������TI1F�ĵ͵�ƽ���½��ء�
			//CC1ͨ������Ϊ����(�ο�ͼ61)��
			//0����׽������TI1F�ĸߵ�ƽ�������أ�
			//1����׽������TI1F�ĵ͵�ƽ���½��ء�
			//ע1��һ��LOCK����(TIM1_BKR�Ĵ����е�LCCKλ)��Ϊ3��2�����λ���ܱ��޸ġ�
			//ע2�������л��������ͨ������λ��Ԥװ�صġ����CCPC=1��TIM1_CR2�Ĵ�������ֻ����
			//COM�¼�����ʱ��CC1Pλ�Ŵ�Ԥװ��λ��ȡ��ֵ��
		//BIT0�����벶��/�Ƚ�1���ʹ��
			//CC1ͨ������Ϊ�����
			//0�� �رգ� OC1��ֹ��������OC1�������ƽ������MOE��OSSI��OSSR��OIS1��OIS1N��CC1NEλ��ֵ��
			//1�� ������ OC1�ź��������Ӧ��������ţ��������ƽ������MOE��OSSI��OSSR��OIS1 �� OIS1N �� CC1NE λ �� ֵ ��                                                                                          CC1ͨ������Ϊ���룺
			//��λ�����˼�������ֵ�Ƿ��ܲ�����TIM1_CCR1�Ĵ�����
			//0�������ֹ��
			//0������ʹ�ܡ�
			//ע�������л��������ͨ������λ��Ԥװ�صġ����CCPC=1(TIM1_CR2�Ĵ���)��ֻ����
			//COM�¼�����ʱ��CC1Eλ�Ŵ�Ԥװ��λ��ȡ��ֵ��
	//TIM1CCER2 =0B01010000;  //4 
    TIM1CCER2 =0B00000000;  //4 
    
    TIM1CNTRH =0B00000000;//TIM1������
    TIM1CNTRL =0B00000000;
    
    TIM1PSCRH =0B00000000;
    TIM1PSCRL =0B00000000;
    
    TIM1ARRH =0x03;        //�Զ����أ����� 
    TIM1ARRL =0;//0xe8;    //62.5NS * 768 = 48US = 20.8K
    
    TIM1RCR =0B00001111;   //�ظ���������ֵ
    
    //TIM1CCR1H =0;//0x01;       //PWM����
    //TIM1CCR1L =0;//0xf4;
    
    //TIM1CCR2H =0B00000000;
    //TIM1CCR2L =0B00000000;
    
    //TIM1CCR3H =0B00000000;
    //TIM1CCR3L =0B00000000;
    
    TIM1CCR4H =0B00000000;
    TIM1CCR4L =0B00000000;
    
    TIM1BKR =0B11000000;   //���ʹ�ܣ���ֹɲ��
    TIM1DTR =0B00000111;   //����������
    //BIT7~BIT0: ��������������,��Щλ�����˲��뻥�����֮�����������ʱ�䡣����DT��ʾ�����ʱ�䣬tCK_PSCΪTIM1��ʱ�����壺
		//DTG[7:5]=0xx => DT=DTG[7:0]x tdtg�����У� tdtg=tCK_PSC.	(f1)
		//DTG[7:5]=10x => DT=(64+DTG[5:0])x tdtg�����У�tdtg= tCK_PSC.	(f2) 
		//DTG[7:5]=110 => DT=(32+DTG[4:0])x tdtg�� �� �� ��tdtg=8x tCK_PSC. (f3) 
		//DTG[7:5]=111 => DT=(32+DTG[4:0])x tdtg�� �� �� ��tdtg=16x tCK_PSC. (f4)

    TIM1OISR =0B00000000; //�������״̬����
    //BIT1���������״̬1(OC1N���)��
			//0����MOE=0ʱ������һ������ʱ���OC1N=0��
			//1����MOE=0ʱ������һ������ʱ���OC1N=1��
			//ע���Ѿ�������LOCK(TIM1_BKR�Ĵ���)����1��2��3�󣬸�λ���ܱ��޸ġ�
		//BIT0���������״̬1(OC1���)��
			//0����MOE=0ʱ�����OC1Nʹ�ܣ�����һ��������OC1=0��
			//1����MOE=0ʱ�����OC1Nʹ�ܣ�����һ��������OC1=1��
			//ע���Ѿ�������LOCK(TIM1_BKR�Ĵ���)����1��2��3�󣬸�λ���ܱ��޸ġ�

    LEBCON =0B00000000; //ǰ��������ֹ
    //BIT7	ǰ������ʹ��λ������ADGO=0ʱ�ɽ����л�������ADC�����쳣��
			//1 = ʹ��
			//0 = ��ֹ
		//BIT6~BIT5:	ǰ������ͨ��ѡ��
			//00 = TIM1_CH1
			//01 = TIM1_CH2
			//10 = TIM1_CH3
			//11 = TIM1_CH4
		//BIT4:N/A	����λ����0
		//BIT3:	PWM������ѡ��
			//0 = PWM������
			//1 = PWM�½���
		//BIT2~BIT0:TIM1�Ĺ���Դʹ�ܣ�����Ч
			//BKS2��ѡ��ADC��ֵ�Ƚ�
			//BKS1��ѡ��LVD���
			//BKS0��ѡ��BKIN�ܽ�
}


/*-------------------------------------------------
 *	�������ƣ�Time2Initial
 *	���ܣ�    TIM2ͨ���ж���RB3���Ƶ��Ϊ4kHz�ķ���
 *	���������
 *	���ز������� 
 -------------------------------------------------*/
void Time2Initial(void)
{
	PCKEN |=0B00000100;    //ʹ��timer2ʱ��ģ��
    CKOCON=0B00100000;
    TCKSRC|=0B00010000;    //TIM2ʱ��ΪHIRC��1��Ƶ
	TIM2CR1 =0B10000101;  //Ԥ�����������ض������ϼ�������������ʹ��
	TIM2IER =0B00000001;
    //TIM2ARRH =0x0B;        //�Զ����أ�����
    //TIM2ARRL =0x90;        //62.5NS * 2960 =  185us *2= 2.7K    
    TIM2ARRH =0x06;        //�Զ����أ�����
    TIM2ARRL =0x40;          //62.5NS * 1600 =  100us
    //GIE =1;                //�����ж�
  }

/*----------------------------------------------------
 *	�������ƣ�TIMER4_INITIAL
 *	���ܣ���ʼ�����ö�ʱ��
 *
 *	����TMR4��ʱʱ��560us                     
 ----------------------------------------------------*/
void Time4Initial(void)
{
	PCKEN |=0B00001000;      //TIME4ģ��ʱ��ʹ��
    //CKOCON=0B00110000;
    //TCKSRC=0B00000011;		
    
    TIM4CR1	=0B00000101;    //HIRC
    //BIT7: 0��TIM1_ARR�Ĵ���û�л��壬�����Ա�ֱ��д��; 1��TIM1_ARR�Ĵ�����Ԥװ�ػ��������塣
    //BIT6:����
    //BIT5~BIT4:timer4ʱ��ѡ��λ��
        		//00��ϵͳʱ��/��ʱ��
				//01���ڲ���ʱ��HIRC
				//10��LPʱ�ӣ�ֻ�е�FOSCѡ��LPģʽʱ��������
				//11��XTʱ�ӣ�ֻ�е�FOSCѡ��XTģʽʱ��������

    //BIT3:
    //			0���ڷ��������¼�ʱ����������ֹͣ��
	//			1���ڷ�����һ�θ����¼�(���CENλ)ʱ��������ֹͣ��

    //BIT2:
   	// 		0�����UDIS�������������¼�����������һ�¼�����һ�������жϣ�
				//�Ĵ���������(����������/����)
				//��������UGλ
				//ʱ��/���������������ĸ���
	//		1�����UDIS�������������¼�����ֻ�е������¼�����ʱ�Ų��������жϣ���UIF��1��
				//�Ĵ���������(����������/����)

    //BIT1:
    //		0��һ�������¼���������������(UEV)�¼���
				//���������/����
				//�������������¼�
				//ʱ��/����ģʽ������������Ӳ����λ������ļĴ�����װ�����ǵ�Ԥװ��ֵ��
	//		1�������������¼���Ӱ�ӼĴ���(ARR��PSC��CCRx)�������ǵ�ֵ�����������UGλ��ʱ��/����������������һ��Ӳ����λ�����������Ԥ��Ƶ�������³�ʼ����

    // BIT0: 0����ֹ��������1��ʹ�ܼ�������


    TIM4IER	=0B00000001;
    //BIT0:  0����ֹ�����жϣ�1�����������жϡ�

    TIM4SR	=0B00000000;
    //BIT0:�����������¼�ʱ��λ��Ӳ����1����������д1��0
			//0���޸����¼�������
			//1�������¼��ȴ���Ӧ�����Ĵ���������ʱ��λ��Ӳ����1��
			//��TIM4_CR1�Ĵ�����UDIS=0�������������������ʱ��
			//��TIM4_CR1�Ĵ�����UDIS=0��URS=0��������TIM4_EGR�Ĵ�����UGλ�����Լ�����
			//CNT���³�ʼ��ʱ��
			//��TIM4_CR1�Ĵ�����UDIS=0��URS=0����������CNT�������¼����³�ʼ��ʱ��

    TIM4EGR	=0B00000000;
    //BIT0:��λ��������1����Ӳ���Զ���0��
	//0���޶�����
	//1�����³�ʼ����������������һ�������¼���ע��Ԥ��Ƶ���ļ�����Ҳ����0(����Ԥ��Ƶϵ������)���������ĶԳ�ģʽ�»�DIR=0(���ϼ���)�����������0����DIR=1(���¼���)�������ȡTIM1_ARR��ֵ��

    TIM4CNTR=0; //TIM4 8λ������
    
    TIM4PSCR=0B00000110;
    //Ԥ��Ƶ���������CK_PSCʱ�ӽ��з�Ƶ��
	//��������ʱ��Ƶ��fCK_CNT����fCK_PSC/2(PSC[2:0])��PSC[7:3]��Ӳ����0��
	//PSCR�����˵������¼�����ʱװ�뵱ǰԤ��Ƶ���Ĵ�����ֵ(�����������TIMx_EGR�Ĵ�����UGλ�����ļ���������¼�)������ζ����Ҫ�µ�Ԥ��Ƶֵ��Ч��������������¼�����CEN=0��
    TIM4ARR	=124;  //8usʱ���׼ 1ms
    TIM4ARR	=22;  //8us * 23 =  185us *2= 2.7K 	
    //ARR�����˽�Ҫװ����ʵ�ʵ��Զ���װ�ؼĴ�����ֵ��
	//���Զ���װ�ص�ֵΪ��ʱ����������������

    //INTCON |= 0B11000000;    //�����жϺ������ж�
  }


/*-------------------------------------------------
 *  ������: Px_Level_Change_INITIAL
 *	���ܣ�  �˿ڵ�ƽ�仯�жϳ�ʼ��
 *  ���룺  ��
 *  �����  ��
--------------------------------------------------*/
void Px_Level_Change_INITIAL(void)
{
    EPS0=0B00000000; 	//
    //Px0~Px3�жϹܽ�ѡ��
    EPS1=0B00000001;   //ѡ��PB4�ܽ��ж�
    //Px4~Px7�жϹܽ�ѡ�� 
    ITYPE0 = 0B00000000;//˫���ж�
    ITYPE1 = 0B11000000;  
    EPIE0  = 0B00010000;//ʹ���ж�4
    INTCON = 0B01000000;  //�����ж�ʹ��
}

/*-------------------------------------------------
 *  ������: UART_INITIAL
 *	���ܣ�  ������
 *  ���룺  ��
 *  �����  ��
 --------------------------------------------------*/
void UART_INITIAL(void)
{
	PCKEN |=0B00100000;	//��UARTʱ��
    
    URIER =0B00000000;  //ʹ�ܷ������ж�
    URLCR =0B00000001;  //8λ���ݣ�ֹͣλ1������żУ��
    URMCR =0B00011000;
    
    //URDLL =104;         //9600������ = Fosc/16*[URDLH:URDLL]   16M
	URDLL =52;         //9600������ = Fosc/16*[URDLH:URDLL]   8M
    URDLH =0;
    TCF=1;
	//INTCON=0B11000000;
    //TCF: ������ɱ�־
    //TXEF:1���ͼĴ���Ϊ��
    //RXNEF:1���ռĴ����ǿ�
}

/*------------------------------------------------- 
 *	�������ƣ�DelayUs
 *	���ܣ�   ����ʱ���� --16M-2T--��ſ�1%����.
 *	���������Time��ʱʱ�䳤�� ��ʱʱ��Time Us
 *	���ز������� 
 -------------------------------------------------*/
void DelayUs(unsigned char Time)
{
	unsigned char a;
	for(a=0;a<Time;a++)
	{
		NOP();
	}
}                  
/*-------------------------------------------------
 *	�������ƣ�DelayMs
 *	���ܣ�   ����ʱ����
 *	���������Time��ʱʱ�䳤�� ��ʱʱ��Time ms
 *	���ز������� 
 -------------------------------------------------*/
void DelayMs(unsigned char Time)
{
	unsigned char a,b;
	for(a=0;a<Time;a++)
	{
		for(b=0;b<5;b++)
		{
		 	DelayUs(197); //��1%
		}
		CLRWDT();
	}
}
/*-------------------------------------------------
 *	�������ƣ�DelayS
 *	���ܣ�   ����ʱ����
 *	���������Time��ʱʱ�䳤�� ��ʱʱ��Time S
 *	���ز������� 
 -------------------------------------------------*/
void DelayS(unsigned char Time)
{
	unsigned char a,b;
	for(a=0;a<Time;a++)
	{
		for(b=0;b<10;b++)
		{
		 	DelayMs(100); 
		}
	}
}

void TIME_INIT()
{
	Time100Ms=0;
	TimeSec=0;
	//TimeMin=0;
}


void User_init()
{
	uSysFunFlg0 = off;
	uSysFunFlg1 = off; 
	uSysFunFlg2 = off; 
	TIME_INIT();

	KeyType=NullKey; 
    DspIndex =DsSty; 	
}

void Display_init()
{
	// SetAllLed();
	// uchar delayCnt=0;
	// while (++delayCnt<100)
	// {
	// 	SetCom1();
	// 	DelayMs(1);
	// 	SetCom2()
	// 	DelayMs(1);
	// 	SetCom3();
	// 	DelayMs(1);
	// 	SetCom4()
	// 	DelayMs(1);
	// }

	ClrAllLed() 
	INTCON |= 0B11000000;    //�����жϺ������ж�
}











